## v4

- 一个蓝图多个模块(book,user...)

```python
# app/web/__init__.py
from flask import Blueprint
web = Blueprint('web', __name__)
from app.web import book
from app.web import user

# app/web/book.py
from . import web
@web.route('/user')
def login():
    return 'success.'

# app/web/user.py
@web.route('/user')
def login():
    return 'success.'
```

- 注册蓝图

```python
# app/__init__.py
def create_app():
    app = Flask(__name__)
    app.config.from_object('config')
    register_buleprint(app)
    return app

def register_buleprint(app):
    from app.web import web
    app.register_blueprint(web)
    
```

##  v4 

- 表单和验证

```python
# app/forms/book.py
from wtforms import Form, StringField, IntegerField
from wtforms.validators import Length, NumberRange, DataRequired

class SearchForm(Form):
    q = StringField(validators=[DataRequired(), Length(min=1, max=30)])
    page = IntegerField(validators=[NumberRange(min=1, max=99)], default=1)

# app/web/book.py
form = SearchForm(request.args)
print(form.errors)
```

## v4 

- 定义书籍模型类

```python
# app/models/book.py
from flask_sqlalchemy import SQLAlchemy
from sqlalchemy import Column,Integer,String

db = SQLAlchemy()

class Book(db.Model):
    __tablename__ = 'book'
    id = Column(Integer, primary_key=True, autoincrement=True)
    title = Column(String(50), nullable=False)
    _author = Column('author', String(30), default='未名')
    binding = Column(String(20))
```

```python
# app/__init__.py
from app.models.book import db

def create_app():
    app = Flask(__name__)
    app.config.from_object('app.setting')
    app.config.from_object('app.secure')

    # 启用flask-SQLAlchemy插件,初始化并创建表
    db.init_app(app)
    db.create_all(app=app)
    return app
```

---

## v5 

- 使用with来实现上下文

```python
# 实现了上下文协议的对象使用with
# 上下文管理器
with app.app_context():
    a = current_app
    d = current_app.config['DEBUG']
    print(a, d)
```

---

## v6 

- 线程隔离的werkzeug.local.Local

```python
import threading
import time
from werkzeug.local import Local

my_obj = Local()
my_obj.b = 1

def worker():
    my_obj.b = 2
    print('in new thread b is: {}'.format(my_obj.b))

new_t = threading.Thread(target=worker, name='qiyue_thread')
new_t.start()
time.sleep(1)

# 主线程
print('in main thread b is: {}'.format(my_obj.b))

# 输出
in new thread b is: 2
in main thread b is: 1
```

- 线程隔离的werkzeug.local.LocalStack

```python
import threading
import time

from werkzeug.local import LocalStack

my_stack = LocalStack()
my_stack.push(1)
print('in main thread after push, value is: {}'.format(my_stack.top))

def worker():
    print('in new thread before push, value is: {}'.format(my_stack.top))
    my_stack.push(2)
    print('in new thread after push, value is: {}'.format(my_stack.top))

new_t = threading.Thread(target=worker, name='qiyue-thread')
new_t.start()
time.sleep(1)
# 主线程
print('finally, in main thread value is: {}'.format(my_stack.top))

# 输出
in main thread after push, value is: 1
in new thread before push, value is: None
in new thread after push, value is: 2
finally, in main thread value is: 1

```

- 以线程ID号作为key的字典 -> Local -> LocalStack

- AppContext RequestContext -> localStack

- Flask -> AppContext     Request -> RequestContext

- current_app -> (LocalStack.top == AppContext top.app == Flask)

- request -> (LocalStack.top == RequestContext top.request == Request)

- 启动多线程:

```python
# 程序入口 fisher.py
from app import create_app

app = create_app()

if __name__ == '__main__':
    app.run(host='127.0.0.1', port=5000, threaded=True, debug=app.config['DEBUG'])
```

---

## v7 

- 重构鱼书YuShuBook

```python
# app/spider/yush_book.py
class YuShuBook:
    isbn_url = 'http://t.yushu.im/v2/book/isbn/{}'
    keyword_url = 'http://t.yushu.im/v2/book/search?q={}&count={}&start={}'

    def __init__(self):
        self.total = 0
        self.books = []

    def search_by_isbn(self, isbn):
        url = self.isbn_url.format(isbn)
        result = HTTP.get(url)
        self.__fill_single(result)

    def __fill_single(self, data):
        if data:
            self.total = 1
            self.books.append(data)

    def search_by_keyword(self, keyword, page=1):
        # 处理分页转换(每页数count，每页开始索引start)
        size = current_app.config['PRE_PAGE']
        url = self.keyword_url.format(keyword, size, (page - 1) * size)
        # url = self.keyword_url.format(keyword, current_app.config['PRE_PAGE'], self.calc_start(page))
        result = HTTP.get(url)
        self.__fill_collection(result)

    def __fill_collection(self, data):
        self.total = data['total']
        self.books = data['books']

    # def calc_start(self, page):
    #     return (page - 1) * current_app.config['PRE_PAGE']

```

- 面向对象方式构造Book view_model类

```python
# app/view_models/book.py

# 定义BookViewModel
class BookViewModel:
    def __init__(self, book):
        self.title = book['title']
        self.publisher = book['publisher']
        self.pages = book['pages'] or ''
        self.author = '、'.join(book['author'])
        self.price = book['price']
        self.summary = book['summary'] or ''
        self.image = book['image']

# 定义BookCollection
class BookCollection:
    def __init__(self):
        self.total = 0
        self.books = []
        self.keyword = ''

    def fill(self, yushu_book, keyword):
        self.total = yushu_book.total
        self.keyword = keyword
        self.books = [BookViewModel(book) for book in yushu_book.books]
```

- 搜索书籍的视图函数

```python
# app/web/book.py
books = BookCollection()
yushu_book = YuShuBook()
if isbn_or_key == 'isbn':
    yushu_book.search_by_isbn(q)
else:
    yushu_book.search_by_keyword(q, page)
books.fill(yushu_book, q)
```

- 对象的序列化

```python
# 多层嵌套对象的处理
# [<class Book {}>,<class Book {}>,<class Book {}>]
json.dumps(books, default=lambda o: o.__dict__)
```

---

## v8 
- 定义静态文件的目录
- 定义模版文件的目录
- send_static_file区分下载权限的文件

---

## v9

- BookViewModel合并多个属性(书籍简介)

```python
@property
def intro(self):
    intros = filter(lambda x: True if x else False,
                    [self.author, self.publisher, self.price])
    return '/'.join(intros)
```

- YuShuBook添加返回第1本书籍

```python
@property
def first(self):
    return self.books[0] if self.total > 0 else None
```

- 书籍详情

```python
@web.route('/book/<isbn>/detail')
def book_detail(isbn):
    yushu_book = YuShuBook()
    yushu_book.search_by_isbn(isbn)
    book = BookViewModel(yushu_book.first)
    return render_template('book_detail.html', book=book, wishes=[], gifts=[])
```

## v9 用户登录、注册

- 注册和登录表单

```python
# app/forms/auth.py
from wtforms import Form, IntegerField, StringField, PasswordField
from wtforms.validators import DataRequired, Length, NumberRange, Email
from app.models.user import User

class RegisterForm(Form):
    email = StringField(validators=[DataRequired(), Length(8, 64),
                                    Email(message='电子邮件不符合规范')])

    password = PasswordField(validators=[
        DataRequired(message='密码不可以为空，请输入你的密码'), Length(6, 32)])

    nickname = StringField(validators=[DataRequired(),
                                       Length(2, 10, message='昵称至少需要两个字符，最多10个字符')])
    # 验证邮箱 是否已存在
    def validate_email(self, field):
        if User.query.filter_by(email=field.data).first():
            raise ValidationError('电子邮件已被注册')

    # 验证昵称 是否已存在
    def validate_nickname(self, field):
        if User.query.filter_by(nickname=field.data).first():
            raise ValidationError('昵称已存在')

class LoginForm(Form):
    email = StringField(validators=[DataRequired(), Length(8, 64),
                                    Email(message='电子邮件不符合规范')])

    password = PasswordField(validators=[
        DataRequired(message='密码不可以为空，请输入你的密码'), Length(6, 32)])

```

- 表单校验，form数据赋值到模型的字段

```python
# app/web/auth.py
from flask_login import login_user
from app.forms.auth import RegisterForm, LoginForm

@web.route('/register', methods=['GET', 'POST'])
def register():
    form = RegisterForm(request.form)
    if request.method == 'POST' and form.validate():
        user = User()
        user.set_attrs(form.data)
        ...

@web.route('/login', methods=['GET', 'POST'])
def login():
    form = LoginForm(request.form)
    print(form.data)
    if request.method == 'POST' and form.validate():
        user = User.query.filter_by(email=form.email.data).first()
        if user and user.check_password(form.password.data):
            login_user(user, remember=True)

            # 处理下一个url,并重定向
            # http://localhost:5000/login?next=/book/search
            next = request.args.get('next')
            if not next or not next.startswith('/'):
                next = url_for('web.index')
            return redirect(next)
            ...

```

- 定义数据模型基类，其它模型引用Base

```python
# app/models/base.py
from flask_sqlalchemy import SQLAlchemy
from sqlalchemy import Column, Integer, SmallInteger
from datetime import datetime

db = SQLAlchemy()
class Base(db.Model):
    __abstract__ = True  # 不创建数据表
    create_time = Column('create_time', Integer)
    status = Column(SmallInteger, default=1)
    
    def __init__(self):
        self.create_time = int(datetime.now().timestamp())
     
    # 把前端的form数据动态赋值到模型
    def set_attrs(self, attrs_dict):
        for key, value in attrs_dict.items():
            if hasattr(self, key) and key != 'id':
                setattr(self, key, value)
```

- 用户模型的password，添加getter和setter方法

```python
# app/models/user.py
from werkzeug.security import generate_password_hash, check_password_hash
from app import login_manager
from flask_login import UserMixin
# UserMixin包含的方法:is_authenticated(),is_active(),is_anonymous(),get_id()

class User(Base, UserMixin):
    _password = Column('password', String(128), nullable=False)

    @property
    def password(self):
        return self._password

    @password.setter
    def password(self, raw):
        self._password = generate_password_hash(raw)
    
    # 用户登录检查密码
    def check_password(self, raw):
        return check_password_hash(self._password, raw)
    
    # flask-login根据get_id来获取实例的用户ID
    def get_id(self):
        return self.id

# 获取user，绑定到当前的上下文
@login_manager.user_loader
def get_user(uid):
    return User.query.get(int(uid))

```

- 加载登录插件flask-login

```python
# app/__init__.py
from flask_login import LoginManager
login_manager = LoginManager()
def create_app():
    ...
    login_manager.init_app(app)
    login_manager.login_view = 'web.login'
    login_manager.login_message = '请先登录或注册'
```

![flask_login](test/flask_login.png)


---

## v10
